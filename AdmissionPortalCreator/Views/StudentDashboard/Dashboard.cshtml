@model AdmissionPortalCreator.ViewModels.StudentDashboardViewModel
@{
    ViewData["Title"] = "Student Dashboard";
}

<div class="container-fluid px-4 py-5">
    <!-- Welcome Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-white p-4">
                    <h2 class="mb-2">👋 Welcome back, @Model.StudentName!</h2>
                    <p class="mb-0 opacity-75">
                        <i class="bi bi-building"></i> @Model.TenantName
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="rounded-circle bg-primary bg-opacity-10 d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="bi bi-file-earmark-text fs-3 text-primary"></i>
                    </div>
                    <h3 class="mb-1">@(Model.ActiveForms?.Count(f => f.Status == "Active") ?? 0)</h3>
                    <p class="text-muted mb-0 small">Active Applications</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="rounded-circle bg-success bg-opacity-10 d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="bi bi-check-circle fs-3 text-success"></i>
                    </div>
                    <h3 class="mb-1">@(Model.SubmittedFormIds?.Count ?? 0)</h3>
                    <p class="text-muted mb-0 small">Submitted Applications</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="rounded-circle bg-warning bg-opacity-10 d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="bi bi-hourglass-split fs-3 text-warning"></i>
                    </div>
                    <h3 class="mb-1">@(Model.ActiveForms?.Count(f => f.Status == "Active" && !(Model.SubmittedFormIds?.Contains(f.FormId) ?? false)) ?? 0)</h3>
                    <p class="text-muted mb-0 small">Pending Applications</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Available Applications Section -->
    <div class="row mb-4">
        <div class="col-12">
            <h4 class="mb-3">
                <i class="bi bi-clipboard-check"></i> Available Applications
            </h4>
        </div>
    </div>

    @if (Model.ActiveForms == null || !Model.ActiveForms.Any(f => f.Status == "Active"))
    {
        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                        <h5 class="mt-3 text-muted">No Active Applications Available</h5>
                        <p class="text-muted">Check back later for new application opportunities.</p>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var form in Model.ActiveForms.Where(f => f.Status == "Active"))
            {
                var hasApplied = Model.SubmittedFormIds?.Contains(form.FormId) ?? false;
                var submissionId = hasApplied ? Model.Submissions?.FirstOrDefault(s => s.FormId == form.FormId)?.SubmissionId : null;
                var daysRemaining = (form.EndDate - DateTime.Now).Days;

                <div class="col-lg-6 col-xl-4">
                    <div class="card h-100 border-0 shadow-sm @(hasApplied ? "border-success" : "") position-relative" style="@(hasApplied ? "border-width: 2px !important;" : "")">

                        @* Status Badge *@
                        @if (hasApplied)
                        {
                            <div class="position-absolute top-0 end-0 m-3">
                                <span class="badge bg-success rounded-pill px-3 py-2">
                                    <i class="bi bi-check-circle-fill"></i> Applied
                                </span>
                            </div>
                        }
                        else if (daysRemaining <= 3)
                        {
                            <div class="position-absolute top-0 end-0 m-3">
                                <span class="badge bg-danger rounded-pill px-3 py-2">
                                    <i class="bi bi-exclamation-triangle-fill"></i> Closing Soon
                                </span>
                            </div>
                        }
                        else if (daysRemaining <= 7)
                        {
                            <div class="position-absolute top-0 end-0 m-3">
                                <span class="badge bg-warning rounded-pill px-3 py-2">
                                    <i class="bi bi-clock-fill"></i> @daysRemaining days left
                                </span>
                            </div>
                        }

                        <div class="card-body d-flex flex-column">
                            <div class="mb-3">
                                <h5 class="card-title fw-bold mb-2">@form.Name</h5>
                                <p class="card-text text-muted small" style="min-height: 60px;">
                                    @if (!string.IsNullOrEmpty(form.Description))
                                    {
                                        @(form.Description.Length > 150
                                                                    ? form.Description.Substring(0, 150) + "..."
                                                                    : form.Description)
                                                        }
                                    else
                                    {
                                        <span class="fst-italic">No description available</span>
                                    }
                                </p>
                            </div>

                            <div class="mb-3">
                                <div class="d-flex align-items-center text-muted small mb-2">
                                    <i class="bi bi-calendar3 me-2"></i>
                                    <span>
                                        <strong>Opens:</strong> @form.StartDate.ToString("MMM dd, yyyy")
                                    </span>
                                </div>
                                <div class="d-flex align-items-center text-muted small">
                                    <i class="bi bi-calendar-x me-2"></i>
                                    <span>
                                        <strong>Closes:</strong> @form.EndDate.ToString("MMM dd, yyyy")
                                    </span>
                                </div>
                            </div>

                            @* Progress Bar for Deadline *@
                            @{
                                var totalDays = (form.EndDate - form.StartDate).Days;
                                var daysPassed = (DateTime.Now - form.StartDate).Days;
                                var progressPercentage = totalDays > 0 ? Math.Min((daysPassed * 100.0 / totalDays), 100) : 0;
                                var progressColor = progressPercentage > 80 ? "danger" : (progressPercentage > 50 ? "warning" : "primary");
                            }

                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="text-muted">Time remaining</small>
                                    <small class="text-muted">@daysRemaining days</small>
                                </div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-@progressColor" role="progressbar"
                                         style="width: @progressPercentage%"
                                         aria-valuenow="@progressPercentage" aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                            </div>

                            <div class="mt-auto">
                                @if (hasApplied)
                                {
                                    <div class="d-grid gap-2">
                                        <a href="@Url.Action("ViewSubmission", "FormSubmission", new { submissionId = submissionId })"
                                           class="btn btn-outline-success">
                                            <i class="bi bi-eye"></i> View Application
                                        </a>
                                        <button class="btn btn-secondary" disabled>
                                            <i class="bi bi-check-circle-fill"></i> Already Applied
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <div class="d-grid">
                                        <a href="@Url.Action("ApplyForm", "FormSubmission", new { formId = form.FormId })"
                                           class="btn btn-primary">
                                            <i class="bi bi-pencil-square"></i> Apply Now
                                        </a>
                                    </div>
                                }
                            </div>
                        </div>

                        @* Visual indicator at bottom for applied forms *@
                        @if (hasApplied)
                        {
                            <div class="card-footer bg-success bg-opacity-10 border-0 text-center py-2">
                                <small class="text-success fw-bold">
                                    <i class="bi bi-check2-all"></i> Application Submitted Successfully
                                </small>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    .bg-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    }

    .card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 .5rem 1rem rgba(0,0,0,.15) !important;
        }

    .progress {
        border-radius: 10px;
        background-color: #e9ecef;
    }

    .progress-bar {
        border-radius: 10px;
    }
</style>